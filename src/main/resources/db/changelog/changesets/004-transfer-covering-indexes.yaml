databaseChangeLog:
  - changeSet:
      id: add-affected-addresses-covering-indexes
      author: goldenera
      comment: "Covering indexes for ultra-fast affected addresses lookup. Enables index-only scans on both tables."
      changes:
        # explorer_transfer indexes
        - sql:
            dbms: postgresql
            endDelimiter: ;
            sql: |
              -- Covering index for block_height lookup with from/to addresses included
              CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_transfer_block_height_addresses
              ON explorer_transfer (block_height)
              INCLUDE (from_address, to_address);
        - sql:
            dbms: postgresql
            endDelimiter: ;
            sql: |
              -- Covering index for block_hash lookup with from/to addresses included
              CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_transfer_block_hash_addresses
              ON explorer_transfer (block_hash)
              INCLUDE (from_address, to_address);
        # explorer_tx indexes
        - sql:
            dbms: postgresql
            endDelimiter: ;
            sql: |
              -- Covering index for block_height lookup with sender/recipient addresses included
              CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_tx_block_height_addresses
              ON explorer_tx (block_height)
              INCLUDE (sender, recipient);
        - sql:
            dbms: postgresql
            endDelimiter: ;
            sql: |
              -- Covering index for block_hash lookup with sender/recipient addresses included
              CREATE INDEX CONCURRENTLY IF NOT EXISTS idx_tx_block_hash_addresses
              ON explorer_tx (block_hash)
              INCLUDE (sender, recipient);
      rollback:
        - sql:
            dbms: postgresql
            endDelimiter: ;
            sql: |
              DROP INDEX IF EXISTS idx_transfer_block_height_addresses;
              DROP INDEX IF EXISTS idx_transfer_block_hash_addresses;
              DROP INDEX IF EXISTS idx_tx_block_height_addresses;
              DROP INDEX IF EXISTS idx_tx_block_hash_addresses;
