databaseChangeLog:
        - changeSet:
                  id: 002-convert-tables-to-partitioned
                  author: goldenera
                  dbms: postgresql
                  changes:
                          # ==========================================================
                          # 1. DROP EXISTING STANDARD TABLES (Generated by Hibernate)
                          # ==========================================================
                          - sql:
                                    sql: DROP TABLE IF EXISTS explorer_tx CASCADE;
                          - sql:
                                    sql: DROP TABLE IF EXISTS explorer_transfer CASCADE;
                          - sql:
                                    sql: DROP TABLE IF EXISTS explorer_revert_log CASCADE;
                          # Drop sequences if they exist (to recreate them with CACHE)
                          - sql:
                                    sql: DROP SEQUENCE IF EXISTS explorer_transfer_seq CASCADE;
                          - sql:
                                    sql: DROP SEQUENCE IF EXISTS explorer_revert_log_seq CASCADE;
                          # ==========================================================
                          # 2. CREATE SEQUENCES (Optimized with CACHE)
                          # ==========================================================
                          - createSequence:
                                    sequenceName: explorer_transfer_seq
                                    dataType: bigint
                                    startValue: 1
                                    incrementBy: 1
                                    cacheSize: 10000
                          - createSequence:
                                    sequenceName: explorer_revert_log_seq
                                    dataType: bigint
                                    startValue: 1
                                    incrementBy: 1
                                    cacheSize: 10000
                          # ==========================================================
                          # 3. RE-CREATE EXPLORER TX (Partitioned)
                          # ==========================================================
                          - sql:
                                    splitStatements: false
                                    stripComments: true
                                    sql: |
                                            CREATE TABLE explorer_tx (
                                                hash BYTEA NOT NULL,
                                                block_height BIGINT NOT NULL,
                                                
                                                -- Identifiers
                                                block_hash BYTEA NOT NULL,
                                                tx_index INTEGER NOT NULL,
                                                timestamp TIMESTAMP NOT NULL,
                                                tx_size INTEGER NOT NULL,
                                                
                                                -- Consensus Data (Using INTEGER for Enums/Codes)
                                                tx_version INTEGER NOT NULL,
                                                type INTEGER NOT NULL,
                                                network INTEGER NOT NULL,
                                                nonce BIGINT NOT NULL,
                                                sender BYTEA NOT NULL,
                                                recipient BYTEA,
                                                amount NUMERIC(80,0),
                                                fee NUMERIC(80,0) NOT NULL,
                                                token_address BYTEA,
                                                message BYTEA,
                                                reference_hash BYTEA,
                                                signature BYTEA,
                                                
                                                -- Payload
                                                payload_type INTEGER,
                                                raw_payload BYTEA,

                                                -- PK must include Partition Key
                                                PRIMARY KEY (hash, block_height)
                                            ) PARTITION BY RANGE (block_height);

                                            -- Indexes
                                            CREATE INDEX idx_explorer_tx_block_hash ON explorer_tx(block_hash);
                                            CREATE INDEX idx_explorer_tx_latest ON explorer_tx(block_height DESC, tx_index ASC);
                                            CREATE INDEX idx_explorer_tx_sender_latest ON explorer_tx(sender, block_height DESC);
                                            CREATE INDEX idx_explorer_tx_recipient_latest ON explorer_tx(recipient, block_height DESC);
                                            CREATE INDEX idx_explorer_tx_token_latest ON explorer_tx(token_address, block_height DESC);
                                            CREATE INDEX idx_explorer_tx_ref_hash ON explorer_tx(reference_hash);
                                            CREATE INDEX idx_explorer_tx_timestamp ON explorer_tx(timestamp);

                                            -- Unique Constraint (Must include block_height)
                                            CREATE UNIQUE INDEX uc_explorer_tx_block_pos ON explorer_tx(block_hash, tx_index, block_height);

                                            -- Initial Partitions (0 - 5M)
                                            CREATE TABLE explorer_tx_p0 PARTITION OF explorer_tx FOR VALUES FROM (0) TO (1000000);
                                            CREATE TABLE explorer_tx_p1 PARTITION OF explorer_tx FOR VALUES FROM (1000000) TO (2000000);
                                            CREATE TABLE explorer_tx_p2 PARTITION OF explorer_tx FOR VALUES FROM (2000000) TO (3000000);
                                            CREATE TABLE explorer_tx_p3 PARTITION OF explorer_tx FOR VALUES FROM (3000000) TO (4000000);
                                            CREATE TABLE explorer_tx_p4 PARTITION OF explorer_tx FOR VALUES FROM (4000000) TO (5000000);

                          # ==========================================================
                          # 4. RE-CREATE EXPLORER TRANSFER (Partitioned)
                          # ==========================================================
                          - sql:
                                    splitStatements: false
                                    stripComments: true
                                    sql: |
                                            CREATE TABLE explorer_transfer (
                                                id BIGINT NOT NULL DEFAULT nextval('explorer_transfer_seq'),
                                                block_height BIGINT NOT NULL, -- Partition Key
                                                
                                                block_hash BYTEA NOT NULL,
                                                timestamp TIMESTAMP NOT NULL,
                                                tx_hash BYTEA,
                                                
                                                -- Using VARCHAR for TransferType (readability) 
                                                -- If you use Integer Converter, change to INTEGER!
                                                type INTEGER NOT NULL,
                                                
                                                from_address BYTEA,
                                                to_address BYTEA,
                                                token_address BYTEA,
                                                amount NUMERIC(80,0),
                                                
                                                PRIMARY KEY (id, block_height)
                                            ) PARTITION BY RANGE (block_height);

                                            -- Indexes
                                            CREATE INDEX idx_ex_transfer_from ON explorer_transfer(from_address, block_height DESC);
                                            CREATE INDEX idx_ex_transfer_to ON explorer_transfer(to_address, block_height DESC);
                                            CREATE INDEX idx_ex_transfer_token ON explorer_transfer(token_address, block_height DESC);
                                            CREATE INDEX idx_ex_transfer_tx_hash ON explorer_transfer(tx_hash);

                                            -- Initial Partitions
                                            CREATE TABLE explorer_transfer_p0 PARTITION OF explorer_transfer FOR VALUES FROM (0) TO (1000000);
                                            CREATE TABLE explorer_transfer_p1 PARTITION OF explorer_transfer FOR VALUES FROM (1000000) TO (2000000);
                                            CREATE TABLE explorer_transfer_p2 PARTITION OF explorer_transfer FOR VALUES FROM (2000000) TO (3000000);
                                            CREATE TABLE explorer_transfer_p3 PARTITION OF explorer_transfer FOR VALUES FROM (3000000) TO (4000000);
                                            CREATE TABLE explorer_transfer_p4 PARTITION OF explorer_transfer FOR VALUES FROM (4000000) TO (5000000);
                          - sql:
                                    splitStatements: false
                                    stripComments: true
                                    sql: |
                                            CREATE TABLE explorer_revert_log (
                                                id BIGINT NOT NULL DEFAULT nextval('explorer_revert_log_seq'),
                                                block_height BIGINT NOT NULL, -- Partition Key
                                                
                                                block_hash BYTEA NOT NULL,
                                                
                                                
                                                -- CHANGE: INTEGER instead of VARCHAR
                                                entity_type INTEGER NOT NULL, 
                                                operation_type INTEGER NOT NULL,
                                                
                                                ref_key_1 BYTEA NOT NULL,
                                                ref_key_2 BYTEA,
                                                
                                                old_value JSONB,
                                                
                                                PRIMARY KEY (id, block_height)
                                            ) PARTITION BY RANGE (block_height);

                                            -- Indexes
                                            CREATE INDEX idx_revert_block_hash ON explorer_revert_log(block_hash);
                                            CREATE INDEX idx_revert_keys ON explorer_revert_log(ref_key_1, ref_key_2);

                                            -- Initial Partitions
                                            CREATE TABLE explorer_revert_log_p0 PARTITION OF explorer_revert_log FOR VALUES FROM (0) TO (1000000);
                                            CREATE TABLE explorer_revert_log_p1 PARTITION OF explorer_revert_log FOR VALUES FROM (1000000) TO (2000000);
                                            CREATE TABLE explorer_revert_log_p2 PARTITION OF explorer_revert_log FOR VALUES FROM (2000000) TO (3000000);
                                            CREATE TABLE explorer_revert_log_p3 PARTITION OF explorer_revert_log FOR VALUES FROM (3000000) TO (4000000);
                                            CREATE TABLE explorer_revert_log_p4 PARTITION OF explorer_revert_log FOR VALUES FROM (4000000) TO (5000000);
